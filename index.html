<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de TV Online (Smart TV - M3U - v2.4)</title> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        /* Estilos CSS (sin cambios respecto a v2.3) */
        :root {
            --primary-color: #E50914; /* Rojo Netflix */
            --primary-color-hover: #b80710;
            --background-color: #141414;
            --text-color: #fff;
            --text-color-secondary: #bbb; /* Color para contador, descripciones */
            --card-bg-start: #333;
            --card-bg-end: #222;
            --card-hover-bg-start: #444;
            --card-hover-bg-end: #333;
            --favorite-color: #ffd700;
            --playing-indicator-color: var(--primary-color);
            --volume-bar-color: var(--primary-color); /* Color barra volumen */
            --volume-bar-bg-color: rgba(80, 80, 80, 0.7); /* Fondo barra volumen */
            --border-radius-large: 15px;
            --border-radius-medium: 10px;
            --border-radius-small: 5px;
            --loading-color: var(--primary-color);
            --focus-outline-color: var(--primary-color);
            --focus-outline-width: 3px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0; padding: 0; background-color: var(--background-color);
            color: var(--text-color); overflow: hidden;
            text-rendering: optimizeLegibility; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        .header {
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0));
            padding: 10px 20px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            display: flex; justify-content: flex-start; align-items: center; height: 60px;
        }
        .header img { height: 50px; margin-right: 15px; }
        .container {
            display: flex; flex-direction: row; position: fixed; top: 60px; left: 0; right: 0; bottom: 0;
            padding: 10px; background-color: var(--background-color); gap: 10px;
        }
        #player-container {
            flex: 3; position: relative; border-radius: var(--border-radius-medium); overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4); background-color: #000;
            transition: flex 0.3s ease, margin-right 0.3s ease;
        }
        #my-video {
            width: 100%; height: 100%; object-fit: contain; border-radius: var(--border-radius-medium); background-color: #000;
        }
        #playlist-container {
            flex: 1; background-color: var(--background-color); border-radius: var(--border-radius-medium);
            padding: 15px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); overflow-y: auto;
            display: flex; flex-direction: column; min-width: 300px; max-width: 350px;
            transition: opacity 0.3s ease, transform 0.3s ease, min-width 0.3s ease, max-width 0.3s ease, padding 0.3s ease, flex 0.3s ease, margin-left 0.3s ease;
            opacity: 1; transform: translateX(0); position: relative;
        }
        .playlist-hidden #playlist-container {
            opacity: 0; transform: translateX(100%); min-width: 0; max-width: 0; padding: 0;
            overflow: hidden; flex: 0; margin-left: -10px;
        }
        .playlist-hidden #player-container { flex: 1; margin-right: 0; }
        #playlist-container h2 { margin-top: 0; margin-bottom: 5px; text-align: center; font-size: 1.2em; flex-shrink: 0; }
        #channel-count {
            font-size: 0.85em; color: var(--text-color-secondary); text-align: center;
            margin: 0 0 10px 0; flex-shrink: 0;
        }
        #search {
            width: calc(100% - 22px); padding: 10px; margin: 0 auto 15px auto; display: block;
            border-radius: var(--border-radius-small); border: 1px solid var(--card-bg-start);
            background-color: var(--card-bg-end); color: var(--text-color); font-size: 1em; flex-shrink: 0;
        }
        #search::placeholder { color: #ccc; }
        #search:focus { outline: none; border-color: var(--focus-outline-color); box-shadow: 0 0 5px rgba(229, 9, 20, 0.5); }
        #playlist {
            list-style-type: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto;
            scrollbar-width: thin; scrollbar-color: var(--primary-color) var(--card-bg-end); scroll-behavior: smooth;
        }
        #playlist::-webkit-scrollbar { width: 8px; }
        #playlist::-webkit-scrollbar-track { background: var(--card-bg-end); border-radius: 4px;}
        #playlist::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 4px; border: 2px solid var(--card-bg-end);}
        #playlist li {
            display: flex; justify-content: space-between; align-items: center; cursor: default;
            padding: 8px 12px; margin-bottom: 6px; background: linear-gradient(145deg, var(--card-bg-start), var(--card-bg-end));
            border-radius: var(--border-radius-medium); transition: background 0.2s ease-in-out, box-shadow 0.2s ease, border-left 0.2s ease; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            border-left: 4px solid transparent;
        }
        #playlist li.playing {
            border-left: 4px solid var(--playing-indicator-color);
            background: linear-gradient(145deg, var(--card-hover-bg-start), var(--card-hover-bg-end));
        }
        #playlist li:hover .channel-button { background-color: rgba(255, 255, 255, 0.05); }
        /* Estilo para mensaje de lista vac√≠a */
        #playlist li.empty-message {
            justify-content: center;
            padding: 20px;
            color: var(--text-color-secondary);
            background: none;
            box-shadow: none;
            border-left: none;
            cursor: default;
        }

        .channel-info { display: flex; align-items: center; gap: 12px; overflow: hidden; }
        .channel-info img { width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0; object-fit: cover; border: 1px solid rgba(255, 255, 255, 0.1); }
        .channel-details { overflow: hidden; }
        .channel-title { font-size: 1em; font-weight: 500; color: var(--text-color); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; }
        .channel-desc { font-size: 0.8em; color: var(--text-color-secondary); margin: 2px 0 0 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .star { cursor: pointer; color: #ccc; transition: color 0.2s ease, transform 0.2s ease; font-size: 1em; flex-shrink: 0; padding: 5px; }
        .star:hover { transform: scale(1.1); }
        .star.favorite { color: var(--favorite-color); }
        .star.favorite:hover { color: #e6c300; }
        .channel-button { background: none; border: none; padding: 0; margin: 0; color: inherit; font: inherit; text-align: left; cursor: pointer; display: block; width: 100%; flex-grow: 1; margin-right: 8px; border-radius: var(--border-radius-small); outline: none; transition: background-color 0.2s ease; }
        .channel-button:focus {
            background-color: rgba(229, 9, 20, 0.2);
            outline: var(--focus-outline-width) solid var(--focus-outline-color);
            outline-offset: 2px; box-shadow: none; border-radius: var(--border-radius-medium);
        }
        .star:focus { outline: var(--focus-outline-width) solid var(--favorite-color); outline-offset: 2px; border-radius: 50%; }

        /* Overlays y Loaders */
        .error-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; color: white; text-align: center; padding: 20px; display: none; }
        .error-message { font-size: 1.2em; margin-bottom: 20px; }
        .error-buttons { display: flex; gap: 15px; }
        .error-button { padding: 10px 18px; background-color: var(--primary-color); border: none; border-radius: 5px; color: white; cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9em; }
        .error-button:hover, .error-button:focus { background-color: var(--primary-color-hover); outline: var(--focus-outline-width) solid var(--text-color); outline-offset: 1px; box-shadow: none; }
        .loading-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.1em; color: var(--text-color); display: none; flex-direction: column; align-items: center; gap: 10px; z-index: 5; }
        .loading-indicator.show { display: flex; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.2); border-top: 4px solid var(--loading-color); border-radius: 50%; width: 35px; height: 35px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #player-loading-indicator {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;
            flex-direction: column; align-items: center; gap: 15px; z-index: 10;
            background-color: rgba(0, 0, 0, 0.6); padding: 20px; border-radius: var(--border-radius-medium);
        }
        #player-loading-indicator.show { display: flex; }
        #player-loading-indicator .spinner { width: 45px; height: 45px; }
        #player-loading-indicator span { font-size: 1.1em; color: var(--text-color); }
        #channel-info-overlay {
            position: absolute; bottom: 60px; left: 20px; display: none; align-items: center; gap: 15px;
            z-index: 10; background-color: rgba(0, 0, 0, 0.7); padding: 10px 15px; border-radius: var(--border-radius-medium);
            opacity: 0; transition: opacity 0.5s ease; max-width: 80%;
        }
        #channel-info-overlay.show { display: flex; opacity: 1; }
        #channel-info-overlay img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        #channel-info-overlay div { overflow: hidden; }
        #channel-info-overlay .overlay-title { font-size: 1.2em; font-weight: bold; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0; }
        #channel-info-overlay .overlay-desc { font-size: 0.9em; color: var(--text-color-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0; }
        #volume-indicator {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: var(--volume-bar-bg-color); border-radius: var(--border-radius-small);
            padding: 8px 15px; display: flex; align-items: center; gap: 10px; z-index: 11;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        #volume-indicator.show { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s linear 0s; }
        #volume-indicator i { font-size: 1.1em; color: var(--text-color); width: 20px; text-align: center; }
        #volume-bar-container { width: 100px; height: 6px; background-color: rgba(255, 255, 255, 0.3); border-radius: 3px; overflow: hidden; }
        #volume-bar { height: 100%; width: 50%; background-color: var(--volume-bar-color); border-radius: 3px; transition: width 0.1s linear; }

    </style>
</head>
<body class="playlist-visible">
    <header class="header">
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgVIFxWI-sdOR2bVfpbgCotXquColWskv4u4I9HXZhYdsRewDVRNcJ7iLvtKO2xYucvqOv0DKY2MArMnHGF8IvZBI7NYjg0dkjHUN0N8VXwZ73vKjYOajWC6JTze5n1Hcj19V2COVFkN-TtJA7uR_ALIYyIcvUBOwQN1EmURskiBCI_lJK3hFphdSBuCaQ/w547-h320/logo%20(%20JORGEDEZ%20)%20ROJO%20Y%20BLANCO%20PARA%20VIDEO.jpeg" alt="JORGEDEZ Logo">
    </header>

    <div class="container">
        <div id="player-container">
            <video id="my-video" controls playsinline webkit-playsinline crossorigin="anonymous">
                <source src="" type="application/x-mpegURL">
                Tu navegador no soporta el elemento de video.
            </video>
            <div id="player-loading-indicator">
                <div class="spinner"></div>
                <span>Cargando canal...</span>
            </div>
            <div id="channel-info-overlay">
                <img id="overlay-logo" src="" alt="">
                <div>
                    <p id="overlay-title" class="overlay-title"></p>
                    <p id="overlay-desc" class="overlay-desc"></p>
                </div>
            </div>
            <div id="volume-indicator">
                <i id="volume-icon" class="fas fa-volume-down"></i> <div id="volume-bar-container">
                    <div id="volume-bar"></div>
                </div>
            </div>
        </div>

        <div id="playlist-container">
            <div class="loading-indicator" id="loading-indicator">
                <div class="spinner"></div>
                <span>Cargando...</span>
            </div>
            <h2>Lista de reproducci√≥n</h2>
            <p id="channel-count">Total: 0 canales</p>
            <input type="text" id="search" placeholder="Buscar canal..." disabled>
            <ul id="playlist">
                </ul>
        </div>
    </div>

    <div class="error-overlay" id="error-overlay">
        <div class="error-message" id="error-message">No se pudo cargar el canal. Intente con otro.</div>
        <div class="error-buttons">
            <button class="error-button" id="try-again-button">Intentar nuevamente</button>
            <button class="error-button" id="try-another-button">Probar otro canal</button>
            <button class="error-button" id="reload-list-button" style="display: none;">Recargar Lista</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Reproductor SmartTV v2.4: DOM Cargado."); // Mantenemos versi√≥n para claridad

            const m3uUrl = 'https://raw.githubusercontent.com/sejo48/chanejorgedez/refs/heads/main/listaoficial.m3u';

            let channels = [];
            let favorites = JSON.parse(localStorage.getItem('favoritesTvChannels')) || [];
            let currentChannelIndex = -1;
            let hls = null;
            let isPlaylistVisible = true;
            let overlayTimeout = null;
            let volumeIndicatorTimeout = null;

            // --- DOM Elements (sin cambios) ---
            const bodyElement = document.body;
            const videoPlayer = document.getElementById('my-video');
            const playlistElement = document.getElementById('playlist');
            const searchInput = document.getElementById('search');
            const playerContainer = document.getElementById('player-container');
            const playlistContainer = document.getElementById('playlist-container');
            const errorOverlay = document.getElementById('error-overlay');
            const errorMessage = document.getElementById('error-message');
            const tryAgainButton = document.getElementById('try-again-button');
            const tryAnotherButton = document.getElementById('try-another-button');
            const reloadListButton = document.getElementById('reload-list-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            const playerLoadingIndicator = document.getElementById('player-loading-indicator');
            const channelInfoOverlay = document.getElementById('channel-info-overlay');
            const overlayLogo = document.getElementById('overlay-logo');
            const overlayTitle = document.getElementById('overlay-title');
            const overlayDesc = document.getElementById('overlay-desc');
            const channelCountElement = document.getElementById('channel-count');
            const volumeIndicator = document.getElementById('volume-indicator');
            const volumeIcon = document.getElementById('volume-icon');
            const volumeBar = document.getElementById('volume-bar');

            // --- Funciones (sin cambios l√≥gicos respecto a v2.4, solo la correcci√≥n del comentario) ---
            function showLoading(message = "Cargando...") { if (loadingIndicator) { loadingIndicator.querySelector('span').textContent = message; loadingIndicator.classList.add('show'); } searchInput.disabled = true; playlistElement.innerHTML = ''; channelCountElement.textContent = ''; }
            function hideLoading() { if (loadingIndicator) { loadingIndicator.classList.remove('show'); } searchInput.disabled = false; }
            function showPlayerLoading(show = true) { if (playerLoadingIndicator) { playerLoadingIndicator.classList.toggle('show', show); } if (show && channelInfoOverlay) { channelInfoOverlay.classList.remove('show'); if (overlayTimeout) clearTimeout(overlayTimeout); } }
            function showChannelInfoOverlay(channel) { if (!channelInfoOverlay || !channel) return; const safeTitle = channel.title || 'Canal sin t√≠tulo'; const logoSrc = channel.logo || `https://placehold.co/80x80/222/fff?text=${encodeURIComponent(safeTitle.charAt(0))}`; overlayLogo.src = logoSrc; overlayLogo.alt = safeTitle; overlayTitle.textContent = safeTitle; overlayDesc.textContent = channel.descripcion || ''; overlayLogo.onerror = () => { overlayLogo.src = `https://placehold.co/80x80/222/fff?text=${encodeURIComponent(safeTitle.charAt(0))}`; overlayLogo.onerror = null; }; channelInfoOverlay.classList.add('show'); if (overlayTimeout) clearTimeout(overlayTimeout); overlayTimeout = setTimeout(() => { channelInfoOverlay.classList.remove('show'); }, 4000); }
            async function fetchAndParseM3U(url) { showLoading("Cargando lista M3U..."); console.log(`Reproductor SmartTV v2.4: Buscando M3U desde: ${url}`); let parsedChannels = []; try { const response = await fetch(url, { cache: "no-store" }); if (!response.ok) throw new Error(`Error HTTP: ${response.status}`); const m3uText = await response.text(); console.log("Reproductor SmartTV v2.4: M3U obtenido."); if (!m3uText || m3uText.trim() === '' || !m3uText.includes('#EXTINF')) { throw new Error("Archivo M3U vac√≠o o inv√°lido."); } const lines = m3uText.split(/[\r\n]+/); let currentChannelInfo = null; const extinfRegex = /#EXTINF:(-?\d+)(.*)/; const attributeRegex = /(\S+?)=(?:"([^"]*)"|([^ ]*))/g; const titleCommaRegex = /,(?!")(.*)/; for (const line of lines) { const trimmedLine = line.trim(); if (!trimmedLine || trimmedLine.startsWith('#EXTM3U')) continue; if (trimmedLine.startsWith('#EXTINF:')) { const match = trimmedLine.match(extinfRegex); if (match) { currentChannelInfo = { duration: match[1], attributes: {}, title: '', logo: '', url: '', descripcion: '' }; const restOfLine = match[2] || ''; let attrMatch; while ((attrMatch = attributeRegex.exec(restOfLine)) !== null) { const key = attrMatch[1].toLowerCase(); const value = attrMatch[2] !== undefined ? attrMatch[2] : attrMatch[3]; currentChannelInfo.attributes[key] = value; } if (currentChannelInfo.attributes['tvg-name']) { currentChannelInfo.title = currentChannelInfo.attributes['tvg-name'].trim(); } if (!currentChannelInfo.title) { const titleMatch = restOfLine.match(titleCommaRegex); if (titleMatch && titleMatch[1]) { currentChannelInfo.title = titleMatch[1].trim(); } } if (!currentChannelInfo.title) { currentChannelInfo.title = 'Sin T√≠tulo'; } currentChannelInfo.logo = currentChannelInfo.attributes['tvg-logo'] || ''; currentChannelInfo.descripcion = currentChannelInfo.attributes['tvg-id'] ? `ID: ${currentChannelInfo.attributes['tvg-id']}` : `Canal: ${currentChannelInfo.title}`; } else { console.warn("L√≠nea #EXTINF no reconocida:", trimmedLine); currentChannelInfo = null; } } else if (currentChannelInfo && trimmedLine && !trimmedLine.startsWith('#')) { currentChannelInfo.url = trimmedLine; if (currentChannelInfo.url) { parsedChannels.push(currentChannelInfo); } else { console.warn("Saltando canal sin URL:", currentChannelInfo.title); } currentChannelInfo = null; } } console.log(`Reproductor SmartTV v2.4: Parseados ${parsedChannels.length} canales.`); } catch (error) { console.error('Reproductor SmartTV v2.4: Error cargando/parseando M3U:', error); showM3UError(`Error al cargar la lista M3U: ${error.message}. Verifica la URL e int√©ntalo de nuevo.`); parsedChannels = []; } finally { hideLoading(); return parsedChannels; } }
            function showM3UError(message) { errorMessage.textContent = message; errorOverlay.style.display = 'flex'; tryAgainButton.style.display = 'none'; tryAnotherButton.style.display = 'none'; reloadListButton.style.display = 'inline-block'; setTimeout(() => reloadListButton.focus(), 100); playlistElement.innerHTML = ''; channelCountElement.textContent = 'Error al cargar';}
            function showError(message, channelIndexToShow = -1) { currentChannelIndex = channelIndexToShow; errorMessage.textContent = message; errorOverlay.style.display = 'flex'; tryAgainButton.style.display = 'inline-block'; tryAnotherButton.style.display = 'inline-block'; reloadListButton.style.display = 'none'; setTimeout(() => tryAgainButton.focus(), 100); if (hls) { hls.stopLoad(); } videoPlayer.pause(); showPlayerLoading(false); console.error("Error mostrado (Playback):", message, "Canal:", channelIndexToShow !== -1 ? channels[channelIndexToShow]?.title : 'N/A'); }
            function hideError() { errorOverlay.style.display = 'none'; if (isPlaylistVisible) { focusCurrentOrFirstChannel(); } }
            tryAgainButton.addEventListener('click', () => { hideError(); if (currentChannelIndex !== -1 && currentChannelIndex >= 0 && currentChannelIndex < channels.length) { selectChannel(currentChannelIndex); } else { focusCurrentOrFirstChannel(); } });
            tryAnotherButton.addEventListener('click', () => { hideError(); if (!isPlaylistVisible) { showPlaylist(); } else { focusCurrentOrFirstChannel(); } });
            reloadListButton.addEventListener('click', () => { hideError(); initializeApp(); });
            function showPlaylist() { bodyElement.classList.remove('playlist-hidden'); bodyElement.classList.add('playlist-visible'); isPlaylistVisible = true; focusCurrentOrFirstChannel(); }
            function hidePlaylist() { bodyElement.classList.add('playlist-hidden'); bodyElement.classList.remove('playlist-visible'); isPlaylistVisible = false; }
            function togglePlaylist() { if (isPlaylistVisible) hidePlaylist(); else showPlaylist(); }
            function renderPlaylist(channelsToRender = channels) { playlistElement.innerHTML = ''; if (channelCountElement) { channelCountElement.textContent = `Total: ${channels.length} ${channels.length === 1 ? 'canal' : 'canales'}`; } if (!channelsToRender || channelsToRender.length === 0) { if (channels.length > 0 && searchInput.value) { playlistElement.innerHTML = '<li class="empty-message">No se encontraron canales con ese nombre.</li>'; } else if (channels.length === 0) { playlistElement.innerHTML = '<li class="empty-message">No hay canales para mostrar. Verifica la URL M3U o recarga.</li>'; } else { console.log("RenderPlaylist: channelsToRender vac√≠o sin b√∫squeda."); } return; } const sortedChannels = [...channelsToRender].sort((a, b) => { const aIndex = channels.findIndex(ch => ch.url === a.url); const bIndex = channels.findIndex(ch => ch.url === b.url); const aIsFavorite = favorites.includes(aIndex.toString()); const bIsFavorite = favorites.includes(bIndex.toString()); if (aIsFavorite && !bIsFavorite) return -1; if (!aIsFavorite && bIsFavorite) return 1; return aIndex - bIndex; }); sortedChannels.forEach((channel) => { const originalIndex = channels.findIndex(ch => ch.url === channel.url); if (originalIndex === -1) return; const li = document.createElement('li'); li.dataset.originalIndex = originalIndex; if (originalIndex === currentChannelIndex) { li.classList.add('playing'); } const channelButton = document.createElement('button'); channelButton.classList.add('channel-button'); channelButton.type = 'button'; const safeTitle = (channel.title || 'Canal sin t√≠tulo').replace(/"/g, '&quot;'); const logoSrc = channel.logo || `https://placehold.co/72x72/222/fff?text=${encodeURIComponent(safeTitle.charAt(0))}`; channelButton.innerHTML = ` <div class="channel-info"> <img src="${logoSrc}" alt="${safeTitle}" onerror="this.onerror=null; this.src='https://placehold.co/72x72/222/fff?text=${encodeURIComponent(safeTitle.charAt(0))}';"> <div class="channel-details"> <span class="channel-title">${safeTitle}</span> <p class="channel-desc">${channel.descripcion || ''}</p> </div> </div>`; channelButton.addEventListener('click', () => { selectChannel(originalIndex); hidePlaylist(); }); li.appendChild(channelButton); const star = document.createElement('i'); const isFav = favorites.includes(originalIndex.toString()); star.className = `star fas fa-star ${isFav ? 'favorite' : ''}`; star.dataset.index = originalIndex; star.tabIndex = 0; star.setAttribute('role', 'button'); star.setAttribute('aria-label', `${isFav ? 'Quitar' : 'Marcar'} ${safeTitle} como favorito`); star.addEventListener('click', (e) => { e.stopPropagation(); toggleFavorite(originalIndex.toString()); filterAndRender(searchInput.value.toLowerCase()); }); star.addEventListener('keydown', handleStarKeydown); li.appendChild(star); playlistElement.appendChild(li); }); }
            function filterAndRender(searchTerm) { const filtered = channels.filter(channel => (channel.title && channel.title.toLowerCase().includes(searchTerm)) || (channel.descripcion && channel.descripcion.toLowerCase().includes(searchTerm))); renderPlaylist(filtered); }
            function scrollToCenter(element) { if (!element || !playlistElement) return; const elementRect = element.getBoundingClientRect(); const playlistRect = playlistElement.getBoundingClientRect(); const desiredTop = playlistRect.height / 2 - elementRect.height / 2; const elementOffsetTop = element.offsetTop; const targetScrollTop = elementOffsetTop - desiredTop; playlistElement.scrollTo({ top: targetScrollTop, behavior: 'smooth' }); }
            function focusAndScrollToCenter(element) { if(element) { element.focus({ preventScroll: true }); scrollToCenter(element.closest('li')); } }
            function focusChannelButtonByIndex(index) { const targetLi = playlistElement.querySelector(`li[data-original-index="${index}"]`); if (targetLi) { const targetButton = targetLi.querySelector('.channel-button'); if (targetButton) { focusAndScrollToCenter(targetButton); return true; } } return false; }
            function focusFirstVisibleChannel() { const firstButton = playlistElement.querySelector('.channel-button'); if (firstButton) { focusAndScrollToCenter(firstButton); return true; } searchInput.focus(); return false; }
            function focusCurrentOrFirstChannel() { if (!isPlaylistVisible || channels.length === 0) { searchInput.focus(); return; } if (currentChannelIndex !== -1) { if (focusChannelButtonByIndex(currentChannelIndex)) { return; } } focusFirstVisibleChannel(); }
            function navigateListFocus(direction) { if (!isPlaylistVisible) return; const focusableElements = Array.from(playlistContainer.querySelectorAll('#search, #playlist .channel-button')); if (focusableElements.length === 0) return; let currentFocusIndex = -1; if (document.activeElement.id === 'search') { currentFocusIndex = 0; } else { const activeLi = document.activeElement.closest('li'); const buttonInActiveLi = activeLi?.querySelector('.channel-button'); if (buttonInActiveLi) { currentFocusIndex = focusableElements.findIndex(el => el === buttonInActiveLi); } else { currentFocusIndex = focusableElements.findIndex(el => el === document.activeElement); } } let nextFocusIndex; if (currentFocusIndex === -1) { nextFocusIndex = direction > 0 ? 0 : focusableElements.length - 1; } else { nextFocusIndex = (currentFocusIndex + direction + focusableElements.length) % focusableElements.length; } const nextElement = focusableElements[nextFocusIndex]; if (nextElement) { if(nextElement.id === 'search') { nextElement.focus(); } else { focusAndScrollToCenter(nextElement); } } }
            function handleStarKeydown(e) { const originalIndex = e.target.dataset.index; if (!originalIndex) return; if (e.key === 'Enter' || e.key === 'Ok') { e.preventDefault(); e.stopPropagation(); toggleFavorite(originalIndex); filterAndRender(searchInput.value.toLowerCase()); setTimeout(() => { const liElement = playlistElement.querySelector(`li[data-original-index="${originalIndex}"]`); const buttonToFocus = liElement?.querySelector('.channel-button'); if (buttonToFocus) focusAndScrollToCenter(buttonToFocus); }, 50); } else if (e.key === 'ArrowLeft') { e.preventDefault(); e.stopPropagation(); const button = e.target.closest('li')?.querySelector('.channel-button'); if (button) focusAndScrollToCenter(button); } else if (e.key === 'ArrowUp' || e.key === 'ArrowDown') { e.preventDefault(); e.stopPropagation(); navigateListFocus(e.key === 'ArrowUp' ? -1 : 1); } }
            function selectChannel(index) { if (index < 0 || index >= channels.length) { console.error("√çndice inv√°lido:", index); return; } hideError(); const channel = channels[index]; console.log(`Seleccionando canal ${index}: ${channel.title}`); const previousPlayingLi = playlistElement.querySelector('li.playing'); if (previousPlayingLi) previousPlayingLi.classList.remove('playing'); const newPlayingLi = playlistElement.querySelector(`li[data-original-index="${index}"]`); if (newPlayingLi) newPlayingLi.classList.add('playing'); playVideo(channel.url, index); localStorage.setItem('lastPlayedTvChannel', index.toString()); currentChannelIndex = index; showChannelInfoOverlay(channel); }
            function playVideo(url, channelIndex) { console.log(`Intentando reproducir canal ${channelIndex}: ${channels[channelIndex].title} (${url})`); showPlayerLoading(true); currentChannelIndex = channelIndex; if (hls) { hls.destroy(); hls = null; } videoPlayer.removeAttribute('src'); videoPlayer.load(); videoPlayer.removeEventListener('error', handleVideoElementError); videoPlayer.removeEventListener('playing', handleVideoPlaying); videoPlayer.removeEventListener('waiting', handleVideoWaiting); videoPlayer.removeEventListener('stalled', handleVideoWaiting); if (!url || typeof url !== 'string' || url.trim() === '') { showError("URL inv√°lida o faltante.", channelIndex); return; } const isM3U8 = url.includes('.m3u8') || url.includes('mpegurl'); if (Hls.isSupported() && isM3U8) { console.log("Usando HLS.js"); hls = new Hls({ abrMaxBitrate: -1, fragLoadingMaxRetry: 4, manifestLoadingMaxRetry: 2, levelLoadingMaxRetry: 4 }); hls.on(Hls.Events.ERROR, function(event, data) { console.error('HLS Error:', data); if (data.fatal) { let errorMsg = `Error HLS (${data.details}).`; showError(errorMsg, channelIndex); if (hls) { hls.destroy(); hls = null; } } else { showPlayerLoading(true); } }); hls.loadSource(url); hls.attachMedia(videoPlayer); hls.on(Hls.Events.MANIFEST_PARSED, function() { console.log("Manifiesto HLS parseado."); videoPlayer.play().catch(e => console.warn("Fallo Play() HLS:", e)); }); hls.on(Hls.Events.BUFFER_APPENDING, () => showPlayerLoading(false)); hls.on(Hls.Events.FRAG_BUFFERED, () => showPlayerLoading(false)); hls.on(Hls.Events.FRAG_LOAD_EMERGENCY_ABORTED, () => showPlayerLoading(true)); } else if (isM3U8 && (videoPlayer.canPlayType('application/vnd.apple.mpegurl') || videoPlayer.canPlayType('application/x-mpegURL'))) { console.log("Usando HLS nativo"); videoPlayer.src = url; videoPlayer.addEventListener('error', handleVideoElementError); videoPlayer.addEventListener('loadedmetadata', () => { console.log("Metadatos cargados (nativo)."); videoPlayer.play().catch(e => console.warn("Fallo Play() nativo:", e)); }, { once: true }); videoPlayer.addEventListener('playing', handleVideoPlaying); videoPlayer.addEventListener('waiting', handleVideoWaiting); videoPlayer.addEventListener('stalled', handleVideoWaiting); } else if (!isM3U8) { console.log("Intentando reproducci√≥n directa (no M3U8)"); videoPlayer.src = url; videoPlayer.addEventListener('error', handleVideoElementError); videoPlayer.addEventListener('loadeddata', () => { console.log("Datos cargados (directo)."); videoPlayer.play().catch(e => console.warn("Fallo Play() directo:", e)); }, { once: true }); videoPlayer.addEventListener('playing', handleVideoPlaying); videoPlayer.addEventListener('waiting', handleVideoWaiting); videoPlayer.addEventListener('stalled', handleVideoWaiting); } else { console.error("HLS no soportado o URL M3U8 inv√°lida."); showError("Formato M3U8 no soportado.", channelIndex); } }
            function handleVideoPlaying() { showPlayerLoading(false); }
            function handleVideoWaiting() { showPlayerLoading(true); }
            function handleVideoElementError() { const error = videoPlayer.error; console.error("Error en <video>:", error); let message = "Error desconocido."; if (error) { switch(error.code) { case error.MEDIA_ERR_ABORTED: message = "Reproducci√≥n cancelada."; break; case error.MEDIA_ERR_NETWORK: message = "Error de red."; break; case error.MEDIA_ERR_DECODE: message = "Error de decodificaci√≥n."; break; case error.MEDIA_ERR_SRC_NOT_SUPPORTED: message = "Formato/URL no soportado."; break; default: message = `Error desconocido (c√≥digo ${error.code}).`; break; } } if (!errorOverlay.style.display || errorOverlay.style.display === 'none') { showError(message, currentChannelIndex); } if (hls) { hls.destroy(); hls = null; } }
            function toggleFavorite(indexString) { const index = parseInt(indexString); if (isNaN(index)) return; const indexInFavorites = favorites.indexOf(indexString); if (indexInFavorites > -1) { favorites.splice(indexInFavorites, 1); } else { favorites.push(indexString); } localStorage.setItem('favoritesTvChannels', JSON.stringify(favorites)); console.log("Favoritos actualizados:", favorites); filterAndRender(searchInput.value.toLowerCase()); /* Re-renderizar para ver cambio */ }
            function adjustVolume(delta) { let newVolume = Math.max(0, Math.min(1, +(videoPlayer.volume + delta).toFixed(2))); videoPlayer.volume = newVolume; videoPlayer.muted = newVolume === 0; console.log(`Volumen: ${Math.round(newVolume * 100)}%`); updateVolumeIndicator(newVolume, videoPlayer.muted); showVolumeIndicator(); }
            function updateVolumeIndicator(volume, muted) { if (!volumeIndicator || !volumeBar || !volumeIcon) return; const percentage = muted ? 0 : Math.round(volume * 100); volumeBar.style.width = `${percentage}%`; if (muted || percentage === 0) { volumeIcon.className = 'fas fa-volume-mute'; } else if (percentage <= 50) { volumeIcon.className = 'fas fa-volume-down'; } else { volumeIcon.className = 'fas fa-volume-up'; } }
            function showVolumeIndicator() { if (!volumeIndicator) return; if (volumeIndicatorTimeout) { clearTimeout(volumeIndicatorTimeout); } volumeIndicator.classList.add('show'); volumeIndicatorTimeout = setTimeout(() => { volumeIndicator.classList.remove('show'); volumeIndicatorTimeout = null; }, 2500); }
            playerContainer.addEventListener('wheel', (event) => { if (event.ctrlKey) { event.preventDefault(); const delta = event.deltaY > 0 ? -0.1 : 0.1; adjustVolume(delta); } }, { passive: false });
            function toggleFullscreen() { if (!document.fullscreenElement) { playerContainer.requestFullscreen().catch(err => console.error(`Error FS: ${err.message}`)); } else { document.exitFullscreen(); } }
            document.addEventListener('keydown', (event) => { if (document.activeElement === searchInput) { if (event.key === 'ArrowDown' || event.key === 'Enter' || event.key === 'Ok') { event.preventDefault(); navigateListFocus(1); } else if (event.key === 'ArrowUp') { event.preventDefault(); } return; } if (errorOverlay.style.display === 'flex' && errorOverlay.contains(document.activeElement)) { if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') { const buttons = Array.from(errorOverlay.querySelectorAll('.error-button:not([style*="display: none"])')); const currentIndex = buttons.indexOf(document.activeElement); if (currentIndex !== -1) { const nextIndex = (currentIndex + (event.key === 'ArrowLeft' ? -1 : 1) + buttons.length) % buttons.length; buttons[nextIndex]?.focus(); } event.preventDefault(); } else if (event.key !== 'Backspace' && event.key !== 'Back' && event.key !== 'Enter' && event.key !== 'Ok') { event.preventDefault(); return; } } let preventDefault = true; const activeElementIsButton = document.activeElement.classList.contains('channel-button'); const activeElementIsStar = document.activeElement.classList.contains('star'); switch (event.key) { case ' ': case 'MediaPlayPause': togglePlayPause(); break; case 'MediaStop': videoPlayer.pause(); videoPlayer.currentTime = 0; break; case 'm': case 'M': videoPlayer.muted = !videoPlayer.muted; console.log(`Silenciado: ${videoPlayer.muted}`); updateVolumeIndicator(videoPlayer.volume, videoPlayer.muted); showVolumeIndicator(); break; case 'f': case 'F': toggleFullscreen(); break; case 'Enter': case 'Ok': if (isPlaylistVisible) { if (activeElementIsButton) { document.activeElement.click(); } else if (activeElementIsStar) { preventDefault = false; } else { hidePlaylist(); } } else { showPlaylist(); } break; case 'ArrowUp': if (isPlaylistVisible) { navigateListFocus(-1); } else { adjustVolume(0.1); } break; case 'ArrowDown': if (isPlaylistVisible) { navigateListFocus(1); } else { adjustVolume(-0.1); } break; case 'ArrowRight': if (!isPlaylistVisible) { videoPlayer.currentTime += 10; } else { if (activeElementIsButton) { const star = document.activeElement.closest('li')?.querySelector('.star'); if (star) focusAndScrollToCenter(star); } else { preventDefault = false; } } break; case 'ArrowLeft': if (!isPlaylistVisible) { videoPlayer.currentTime -= 10; } else { if (activeElementIsStar) { const button = document.activeElement.closest('li')?.querySelector('.channel-button'); if (button) focusAndScrollToCenter(button); } else { preventDefault = false; } } break; case 'Backspace': case 'Back': if (errorOverlay.style.display === 'flex') { hideError(); } else if (document.fullscreenElement) { document.exitFullscreen(); } else if (isPlaylistVisible) { hidePlaylist(); } else { preventDefault = false; } break; default: preventDefault = false; break; } if (preventDefault) { event.preventDefault(); } });
            searchInput.addEventListener('input', (e) => { filterAndRender(e.target.value.toLowerCase()); });
            async function initializeApp() { console.log("Reproductor SmartTV v2.4: Inicializando app..."); channels = await fetchAndParseM3U(m3uUrl); renderPlaylist(); if (channels.length > 0) { const lastPlayedIndexStr = localStorage.getItem('lastPlayedTvChannel'); let initialChannelIndex = 0; if (lastPlayedIndexStr !== null) { const lastPlayedIndex = parseInt(lastPlayedIndexStr); if (!isNaN(lastPlayedIndex) && lastPlayedIndex >= 0 && lastPlayedIndex < channels.length) { initialChannelIndex = lastPlayedIndex; } else { localStorage.removeItem('lastPlayedTvChannel'); } } currentChannelIndex = initialChannelIndex; const initialPlayingLi = playlistElement.querySelector(`li[data-original-index="${currentChannelIndex}"]`); if (initialPlayingLi) initialPlayingLi.classList.add('playing'); console.log(`Reproductor SmartTV v2.4: √çndice inicial enfocado: ${currentChannelIndex} (${channels[currentChannelIndex]?.title})`); setTimeout(() => { focusCurrentOrFirstChannel(); updateVolumeIndicator(videoPlayer.volume, videoPlayer.muted); }, 100); } else { console.warn("Reproductor SmartTV v2.4: No se cargaron canales. Enfocando b√∫squeda."); searchInput.disabled = true; playlistContainer.focus(); } console.log("Reproductor SmartTV v2.4: Inicializaci√≥n completada."); }
            initializeApp();

        }); // End DOMContentLoaded
    </script>
</body>
</html>

